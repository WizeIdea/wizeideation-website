name: Sync Obsidian → Wize Ideation → Cloudflare Pages

on:
  workflow_dispatch:            # manual trigger
  push:
    branches:
      - main                    # or whatever default branch you use
    paths:
      - '.github/workflows/**'  # re‑run if the workflow changes


# .github/workflows/obsidian-sync.yml  (only the relevant part shown)

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout the Wize Ideation repo (this repo)
      - name: Checkout site repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Checkout the Obsidian repo into ./obsidian
      - name: Checkout Obsidian repo
        uses: actions/checkout@v4
        with:
          repository: WizeIdea/Obsidian-Scott
          path: obsidian
          ssh-key: ${{ secrets.OBSIDIAN_SSH_KEY }}
          fetch-depth: 0

      # 3️⃣ Install dependencies (includes TypeScript, ts-node not needed here)
      - name: Install deps
        run: npm ci

      # 4️⃣ **Compile the TypeScript helper script as CommonJS**
      - name: Compile copy‑script as CommonJS
        run: npm run build-copy-script

      # 5️⃣ **Run the compiled copier**
      - name: Copy selected markdown
        run: npm run copy-md

      # 6️⃣ Build the static site (Next.js will read the newly‑copied markdown)
      - name: Build static site
        run: npm run build

      # 7️⃣ Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler pages deploy out --project-name=wizeideation
