name: Sync Obsidian ‚Üí Wize Ideation ‚Üí AWS

on:
  workflow_dispatch:            # manual trigger
  push:
    branches:
      - main                    # trigger on any push to main


# .github/workflows/obsidian-sync.yml  (only the relevant part shown)

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing commits back to the repo
    steps:
      # 1Ô∏è‚É£ Checkout the Wize Ideation repo (this repo)
      - name: Checkout site repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Checkout the Obsidian repo into ./obsidian
      - name: Checkout Obsidian repo
        uses: actions/checkout@v4
        with:
          repository: WizeIdea/Obsidian-Scott
          path: obsidian
          ssh-key: ${{ secrets.OBSIDIAN_SSH_KEY }}
          fetch-depth: 0

      # 3Ô∏è‚É£ Install dependencies (includes TypeScript, ts-node not needed here)
      - name: Install deps
        run: npm ci

      # 4Ô∏è‚É£ **Compile the TypeScript helper script as CommonJS**
      - name: Compile copy‚Äëscript as CommonJS
        run: npm run build-copy-script

      # 5Ô∏è‚É£ **Run the compiled copier**
      - name: Copy selected markdown
        run: npm run copy-md

      # 6Ô∏è‚É£ **Commit published papers to website repo for archival**
      - name: Commit published papers
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/papers/*.md content/services/*.md content/projects/*.md 2>/dev/null || true
          git diff --staged --quiet || git commit -m "Archive published papers from Obsidian [skip ci]"
          git push

      # 7Ô∏è‚É£ Build the static site (Next.js will read the newly‚Äëcopied markdown)
      - name: Build static site
        run: npm run build

      # 8Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 9Ô∏è‚É£ Deploy static site to S3
      - name: Deploy static site to S3
        run: |
          # Cache immutable assets aggressively
          aws s3 sync out s3://${{ secrets.S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "404.html"

          # Ensure HTML is always fresh
          aws s3 sync out s3://${{ secrets.S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "index.html" \
            --include "404.html"

      # üîü Invalidate CloudFront cache
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
